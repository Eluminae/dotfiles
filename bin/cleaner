#!/usr/bin/env bash

filmRootPath="/home/eddie/Workspace/VoiciLhistoire"

clean() {
	local file="$1"

	echo "$file" | grep "$filmRootPath" 2> /dev/null
	if [ $? -ne 0 ]
	then
		echo "Not in the good directory"
		return
	fi

	local currentSceneNumber="$(echo "$file" | sed "s;$filmRootPath/scenes/\([^\/]\+\)/.*;\1;")"
	local currentShotNumber="$(echo "$file" | sed "s;$filmRootPath/scenes/\([^\/]\+\)/shots/\([^\/]\+\)/.*;\2;")"
	local currentTakeNumber="$(echo "$file" | sed "s;$filmRootPath/scenes/\([^\/]\+\)/shots/\([^\/]\+\)/takes/\([^\/]\+\)/.*;\3;")"

	if [[ "$preview" == "true" ]]
	then
		gnome-open "$file"
	fi
	read -p "Scene: $currentSceneNumber; Shot: $currentShotNumber; Take: $currentTakeNumber => Is this okay [yn]?" okay

	if [ "$okay" == "n" ]
	then
		derusher "$file" "false"
	fi
	find "$filmRootPath" -type d -empty -print -delete 1> /dev/null
}

cleanAllRecursively() {
	local path="$1"
	shopt -s globstar
	for file in "$path"/**/*.*;
	do
		clean "$(realpath "$file")"
		echo # display by blocks
	done
}

if [ $# == 0 ]; then
	echo "Usage: $0 path doesPreview"
	exit 1
fi

path="$(realpath $1)"
preview="${2:-true}"

if [ -f "$path" ]
then
	clean "$path"
elif [ -d "$path" ]
then
	cleanAllRecursively "$path"
fi

