#!/usr/bin/env bash

filmRootPath="/home/eddie/Workspace/VoiciLhistoire"


derush() {
	local file="$1"

	local sceneNumber=""
	local shotNumber=""
	local takeNumber=""

	local re='^[^\/]+$'
	while ! [[ "$sceneNumber" =~ $re && "$shotNumber" =~ $re && "$takeNumber" =~ $re ]]
	do
		if [[ "$preview" == "true" ]]
		then
			gnome-open "$file"
		fi
		echo "Derush $file"
		read -p "Scene : " sceneNumber
		read -p "Shot : " shotNumber
		read -p "Take : " takeNumber
	done

	local filePath="$filmRootPath/scenes/$sceneNumber/shots/$shotNumber/takes/$takeNumber/$(basename "$file")"
	if [ -f "$filePath" ];
	then
		echo "$filePath already exist"
		return 1
	fi

	mkdir -p "$(dirname "$filePath")"
	#pv "$file" > "$filePath"
	mv "$file" "$filePath"
}

derushAllRecursively() {
	local path="$1"
	shopt -s globstar
	for file in "$path"/**/*.*;
	do
		derush "$file"
		echo
	done
}

if [ $# == 0 ]; then
	echo "Usage: $0 path doesPreview"
	exit 1
fi

path="$(realpath "$1")"
preview="${2:-true}"

if [ -f "$path" ]
then
	derush "$path"
elif [ -d "$path" ]
then
	derushAllRecursively "$path"
fi

